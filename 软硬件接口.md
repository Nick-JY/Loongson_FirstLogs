# 第一章

* 如果不理解内部细节，那么在现代计算机上优化程序性能，将是一个<u>复杂的试验过程</u>，而不是一个<u>建立在深入理解和分析基础上的科学过程</u>。

  ## 理解程序性能

  ### 影响程序性能的因素

  * 源程序语句的数量和I/O操作执行次数      ==算法==
  * 生成的机器指令质量        ==使用的工具语言、编译器、体系结构==
  * 指令的执行速度         ==处理器、存储器==
  * I/O 操作的执行速度          ==硬件、操作系统==

  ## 1.2

  * 简单的软硬件层次化结构：应用软件->系统软件->硬件
  * 系统软件有很多类
    * 两类：操作系统和编译器
      * 操作系统最重要的功能：处理基本输入输出、分配存储空间和内存、为多个程序同时使用计算机提供支持
        * 主要操作系统：Windows,Linux,MacOS
      * 编译器核心功能：高级语言翻译成机器语言
  * 指令是位的集合
  * 将符号翻译成二进制的程序        ==汇编器==
    * 该符号语言就是汇编语言
      * 汇编语言需要程序员为每条机器指令写一条，强迫程序员按机器的方式思考
    * 高级语言的优势
      * 使用英语单词和数学符号（更自然的语言）
      * 可以按用途来设计编程语言
      * 提高程序员生产力（编程花费的时间较少）
      * 程序能够独立于开发它的计算机

  ## 1.3

  * 底层计算机基本功能：输入数据、输出数据、处理数据、存储数据

    ### 计算机的五个组成部分

    输入、输出、存储器、数据通路、控制器

    * 处理器从存储器得到指令和数据，输入将数据写入存储器，输出从存储器读取数据，控制器发送决定对数据通路、存储器、输入和输出进行操作的信号。

### 鼠标

* 机电式
* 全光学式
  * 小型的光学处理器
    * LED
    * 小型黑白摄像头
    * 一个简单的光处理器

### 显示器

* 图形<u>显示器</u>
  * 基于电视技术
  * CRT显示器每次扫描一幅图像的一行，，每秒30~75次。在这种刷新率下，人们不会注意到屏幕的闪烁。
* <u>图像</u>
  * 由像素的矩阵组成。可以用位的矩阵来代表，称为位图。
  * 最简单的显示器每像素1位，允许它是黑或白。
  * 为了让显示器支持256种不同浓淡的灰度信号，每个像素需要8位。
  * 彩色显示器三原色（红绿蓝）的每一色可能都使用8位，每像素就是24位。可以显示几百万种不同的颜色。

---

* 液晶显示器      LCD
  * 体积小，功耗低
  * LCD像素自身不是光源，它控制光的透射。
    * 通过在液体中包含棒状分子形成的扭曲螺旋来使进入显示器的光线弯曲。光线来自放在显示屏背面的光源，也有少部分反射光。
    * 电流通过时这些棒变直并不再弯曲光线。这些液晶材料置于两个偏振方向成90度的镜面间，因此光线不弯曲不能通过。
  * 活动矩阵$LCD$显示器
    * 每个像素上有微小的晶体管开关，从而精确控制电流，得到更锐利的图像
    * 彩色活动矩阵LCD中，每个像素有三个晶体管开关

---

#### 计算机硬件对图形的支持

* 帧缓存区存储位图
  * 每个像素的位模式以刷新速率被读出到图形显示器
  * 当屏幕更新时，人眼能够察觉屏幕上非常微小的变化



### 机箱

* 电源、风扇、主板、散热片、DVD驱动器、高密度软盘驱动器、硬盘驱动器

#### 主板

* 内存

  * 计算机运行时存储<u>程序</u>和<u>运行程序所需的数据</u>
    * 图示的计算机每块小内存板包含8块集成电路

* CPU

  * 执行数字相加、判断、发送信号去激活I/O设备等操作
  * 被风扇和散热片盖着
  * 处理器细节
    * 两个部分：数据通路和控制器       肌肉和头脑
      * 数据通路执行算术运算
      * 控制器根据程序指令的意图告诉数据通路、存储器和I/O设备该干什么

  ---

  ##### 抽象

  * 掩盖底层细节从而为高级层面提供较简单的模型

  ###### 硬件与底层软件之间的接口       ==指令集系统结构==  ==系统结构==

  <u>指令集系统结构包括</u>  : 程序员为使一个二进制机器语言程序正确运行所需要知道的所有事，包括指令、I/O设备等。

  * 指令系统允许计算机设计者脱离执行它们的硬件来讨论功能。很多不同成本和性能的实现能运行相同的软件。

  * 一般操作系统会将I/O操作、存储器分配和其他底层系统功能封装。应用程序程序员不用担心这些细节问题。

  ###### 应用程序二进制接口： 基本指令集和操作系统提供给应用程序员的接口。

  ### 抽象原则

  *硬件和软件都包含分层的层次，每一个较底层次对上一层掩盖细节。*

  ---

  #### 数据的安全位置

  * 计算机里的内存是易失性存储，当内存断电后，它会“忘掉” 其中的内容。
    * 主存一般由DRAM组成，访问时间短

  ***辅存***

  * 台式机和服务器         ==磁性硬盘==
    * 硬盘包括一个盘片组，以每分钟5400~15000圈的速度旋转。金属盘片的两面都涂有磁记录材料，与盒式磁带或录影带上的材料差不多。每面的上方都有一个可移动臂，带有称为读/写头的小电磁线圈。整个磁盘被永久地封装起来，因此磁头能够很贴近磁盘表面。
    * 硬盘大多出现在机箱内部。也可以通过外部接口（数据线或USB接口），外接到计算机上。
    * 机械设备   ->    访问时间长
    * 每兆字节成本低  ->   适度成本就得到很高的存储容量
  * 嵌入式         也使用 <u>闪存</u> (一种非易失半导体内存) 

  ###### 硬盘外的其他存储技术

  * 光盘   CD、DVD

  * 磁带

  * 基于闪存的可移动存储卡

  * 软盘 和高密度软盘（现在已经基本消失）

    * 光盘技术和磁盘技术工作的方式完全不同

      * 每一位用光盘表面所占面积很小的小坑来表示。读取数据时，一束激光照射到光盘表面，根据反射的光来确定该位置是一个坑还是一个平面（反光）。
      * 刻录机在CD 或DVD 的记录层烧制小坑，刻录过程较慢，批量生产时采用“压制”的技术，生产成本因此降低。
      * 可重写：
        * 晶体反射材料不同
        * 删除时将记录表面慢慢加热后慢慢冷却，使记录表面恢复其晶体结构。
        * 可重写CD、DVD更加昂贵。只读式普通CD、DVD 用来发布软件、音乐或电影，因为成本相对低廉。

      ---

      **联网的计算机优势：** 

      * 通信：计算机之间的高速信息交换
      * 资源共享
      * 非本地访问

      **局域网** ：由提供路由和安全服务的交换机互连起来

      **广域网**：一般基于光纤并由电信公司出租。

      ***无线技术*** ：在一个覆盖区域内的所有用户都能收到无线电波，和基于导线传播的网络有很大不同。

      ---

      **处理器和内存的制造技术**

      * 真空管
      * 晶体管： 一个简单的电控开关
      * 集成电路：一个芯片里集成了数千个晶体管
      * 超大规模集成电路    （晶体管集成数目更多）
      * 极大规模集成电路

      ### 集成电路的制造技术

      * **晶体管**       在硅中加入材料制造出的<u>在特定条件下导电或绝缘的区域</u>（像一个开关）
      * **超大规模集成电路**       数以十亿计的导体、绝缘体和开关集成在一个单独的封装中
      
      ###### 制造过程    ==（设计约束1）==
      
      * 硅晶锭切成薄原片
      * 放上各种化学成分，生成晶体管、导体和绝缘体
      
      现在的集成电路只有一层晶体管，但可能含有2~8层用绝缘层隔开的金属导体
      
      ***不可能造出完美的圆片，为了处理不完美性：在单个原片上放置很多相对独立的部件，把原片切割成这些部件，也就是芯片（晶圆）***
      
      * 产率： 圆片上总晶圆数目与产出的合格晶圆的百分比
      
      * 封装： 将好的晶圆连接到一个封装的输入/输出引脚上。封装过程可能会出错，需要对封装部分进行检测。
      
      ###### ==设计约束2==： 功耗
      
      * 正比于晶体管变化次数于变换频率之积
      * CMOS技术：主要能耗来源是晶体管变换时消耗的能量，空闲时不直接消耗能量，使用低时钟频率让处理器“休眠”而节省能源。但漏电使得存在静态能量产生功耗。通过技术和工艺革新来控制漏电。
      
      ---
      
      ### 陷阱
      
      * 计划设计一种新机器时忽略了硬件的持续改进
      
      快速增长的性能价格比。产业的平均性能增长率将给予别的机器以相同的性能。
      
      ---
      
      ## 计算机指令
      
      * 计算机的语言：机器语言
      
        * 单词：指令
        * 单词表：指令集
      
      * 机器语言之间的<u>相似</u>性
      
        所有的计算机都是建立在硬件技术上的。
      
        这些硬件技术基于相似的底层原理。
      
      * 指令集的要求： 设备简单性
    
    ### 计算机硬件的操作
    
    * 任何计算机都必须能够执行算术运算指令
    
    ```add a, b, c        # the sum of b and c is placed in a ```
    
    * 将C语句编译成MIPS
    
    ``` c
    a = b + c;
    d = a - e;
    ```
    
    ```  MIPS
    add a,b,c
    sub d,a,e
    ```
    
    ---
    
    ```c
    f = (g + h) - (i + j)
    ```
    
    ```MIPS
     变量f,g,h,i,j分别分配给寄存器$s0, $s1, $s2, $s3, $s4
     add $t0, $s1, $s2
     add $t1, $s3, $s4
     sub $s0, $t0, $t1
    ```
    
    ### 硬件设计四大原则
    
    1. 简单源自规整。
    
    2. 越少越快。
    3. 加速执行常用操作
    4. 优秀的设计需要适当的折中
    
    ### 计算机硬件的操作数
    
    * 算术指令的操作数必须取自<u>寄存器</u>
    
      MIPS结构中寄存器为32位。**字** 就是成组出现在MIPS系统结构中的32位数。
    
    * 高级语言的变量和寄存器的区别是寄存器的数量有限。典型的计算机中有32个寄存器。
    
      寄存器个数限制为32个，是因为电信号传输距离越远，其传播距离就越长。因此，寄存器太多会延长时钟周期。
    
    * 有效利用寄存器是提高程序性能的关键。
    
    * MIPS规定，使用  `$`  后跟两个字符来代表一个寄存器。例如：\$s0,\$s1
    
      ---
    
       MIPS算术运算操作只作用于寄存器
    
      复杂的数据结构存放在存储器中
    
      需要在存储器和寄存器之间传送数据的指令   ==数据传送指令==
    
      * 指令给出相应的存储器地址。存储器像一个很大的一维数组，其地址相当于数组的下标。该坐标从0开始。
    
      **取指令**
    
      load word     取字
    
      例子：
    
      ```c
      g = h + A[8];
      ```
    
      ```MIPS
      lw $t0, 8($s3) 
      add $t1, $t2, $t0
      ```
    
      **偏移量**： 数据传送指令中的常量
    
      **基址寄存器**：存放基址的寄存器
    
      ---
    
      MIPS 中字的起始地址必须是4的倍数     对齐限制
    
      **存指令**
    
      store word     存储指令
    
      例子
    
      ```c
      A[12] = h + A[8];
      ```
    
      ```MIPS
      lw $t0, 32($s3)
      add $t0, $s2, $t0
      sw $t0, 48($s3)
      ```
    
      ---
    
      避免取指令的办法：有常数操作的快速加指令    *立即数加*
    
      例子：把常数4加到寄存器 \$s3
    
      ```c
      addi $s3,$3,4      # $s3 = $3 + 4
      ```
    
      ### 2.4
    
      指令以一系列高低电平信号形式保存在计算机中，并以数字形式表示。   
    
      *  将寄存器名字映射成对应的序号      映射约定
    
        \$s0 - \$s7     16~23
    
        \$t0 - \$t7      8 ~ 15
    
        指令的数字形式：**机器语言**
    
        指令序列： **机器代码**
    
        ---
    
        所有的MIPS指令都是32位长
    
        ##### MIPS字段
    
        * op    操作码
        * rs     寄存器 操作数1
        * rt      寄存器 操作数2
        * rd     寄存器  目标操作数
        * shamt  位移量
        * funct    函数码
    
        **折中方案**
    
        所有的指令长度相同，不同的指令不同的格式
    
        * R型     寄存器
        * I 型     立即数
    
        ##### MIPS汇编语言翻译成机器语言的例子
    
        ```c
        A[300] = h + A[300];    //C
        ```
    
        ```MIPS
        
        lw $t0, 1200($t1)
        add $t0, $s2, $t0
        sw $t0, 1200($t1)
        ```
    
        ![image-20221020141113970](C:\Users\p'y\AppData\Roaming\Typora\typora-user-images\image-20221020141113970.png)
    
        
    
        * 程序当成二进制文件存储
    
      
    
      ### 2.5
    
      * 掩码：当源操作位数的某位为０时，AND可以设置目标数对应位为0 的模式
    
        ---
    
        ###　分支指令
    
        MIPS汇编包括两条分支指令：
    
        ```MIPS
        beq register1, register2, L1
        ```
    
        $beq$ : branch, equal     如果分支相等
    
        $L1$: 标号为L1的语句
    
        ##### 将if-then-else 语句编译成条件分支指令
    
        ```c
        if (f == j)  f = g + h;
        else  = g - h;
        ```
    
        
    
      
  
